---
title: "Горева Екатерина. Дз №5"
output: html_document
date: "2024-04-10"
---
Библиотеки
```{r}
library(car)
library(ggplot2)
library(tidyverse)
library(ggsurvfit)
library(survminer)
```


Загрузка датасета
```{r}
data <- read.csv("wisconsin_breast_cancer.csv")
data
```
```{r}
# проверка на пропуски
sum(is.na(data))
```
```{r}
# пропусков много. Посмотрим, где они. 
missing_rows <- !complete.cases(data)
missing_counts <- sapply(data, function(x) sum(is.na(x)))
print(missing_counts)
```

Все пропуски в столбце X, который на нашу работу пока не влияет.
```{r}
# проверка на полные дубликаты
data<-data[ !duplicated(data),]
data
```
Полных дубликатов нет

## Задание 1  
Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).
Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.
```{r}
# проверка на пропуски в значимых для задания столбцах
colSums(is.na(data[c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean")]))
```
а) Гипотезы:  
Н0 - нет зависимости среднего радиуса опухоли от фактора.  
H1 - есть зависимость среднего радиуса опухоли от фактора статистически значима  
Альфа = 0.05
```{r}
# линейная регрессия
reg_a <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = data) 
summary(reg_a)
```
```{r}
# проверим нормальность распределения остатков 
shapiro.test(residuals(reg_a))
```
```{r}
# проверям остатки на гомоскедатичность 
plot(reg_a, which = 1)
```
Гомоскедатичность остатков не соблюдается. 

## Интерпретация
Интерпретация результатов модели:

Судя по коэффициентам в графе Estimate, радиус опухоли увеличивается с ростом средней площади и среднего периметра, причем периметр влияет в большей степени. При этом радиус опухоли уменьшается с ростом средней симметрии  (с коэффициентом -4.3541675). Значенеи p-value < alpha, т.е. линейная зависимость статистически значима. 
Модель предсказывает средний радиус опухоли с adjusted R-squared 0.9971, т.е. с веротяностью 99,7%. 

```{r}
# график зависимости зреднего радиуса от средней площади
data %>%
  ggplot(aes(x = area_mean, y = radius_mean)) +
  geom_point() + labs(title = "Зависимость среднего радиуса и средней площади опухоли",
  x = "Площадь опухоли",
  y = "Радиус опухоли") + 
  geom_smooth(method = "lm")
   
```
```{r}
# график зависимости зреднего радиуса от среднего периметра
data %>%
  ggplot(aes(x = area_mean, y = perimeter_mean)) +
  geom_point() + labs(title = "Зависимость среднего радиуса и среднего периметра",
  x = "Периметр",
  y = "Радиус опухоли") + 
  geom_smooth(method = "lm")
```
```{r}
# график зависимости зреднего радиуса от симметрии
data %>%
  ggplot(aes(x = area_mean, y = symmetry_mean)) +
  geom_point() + labs(title = "Зависимость среднего радиуса и средней симметрии",
  x = "Симметрия",
  y = "Радиус опухоли") + 
  geom_smooth(method = "lm")

```
## Интерпетация графиков:  
То, что мы видим на графиках, подтверждает наш предыдущий вывод: в случае с симметрией зависимости нет, а в двух других - есть. 

## Задание 2  
Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).
 Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.
```{r}
# проверка на пропуски в значимых для задания столбцах, которые еще не проверили
colSums(is.na(data[c("diagnosis", "texture_mean")]))
```
 
 
```{r}
# подготовим значения зависимой переменной
# убедимся, что у нас только два варианта содежимого колонки
unique(data$diagnosis)
```
```{r}
# меняем значения 
data$diagnosis <- ifelse(data$diagnosis == "M",1, ifelse(data$diagnosis == "B",0, data$diagnosis))
print(data$diagnosis)

```
 Переменная diagnosis бинарная, поэтому используем логистическую регрессию.
 Гипотезы: 
 Н0: переменная не имеет значимой зависимости от фактора. Н1: значимая зависимость между переменной и фактором есть. Альфа принимаем 0.05.
 
```{r}
# поменяем тип переменной на numeric 
data$diagnosis<-as.numeric(data$diagnosis)
class(data$diagnosis)
```
 
```{r}
reg_b <-glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = data, family = "binomial")
summary(reg_b)
```
  Шансы на то, что опухоль доброкачественная уменьшаются, с увеличением среднего радиуса, судя по значениям Estimate. С ростом средней площади шанс на диагностирования доброкачественной опухоли увеличивается. Чем выше значение текстуры, тем шанс на доброкачественность выше. 

Построим кривую логистической регрессии
```{r}
# для типа и среднего радиуса опухоли
data %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) + geom_point() +
    labs(title = "Зависимость типа и среднего радиуса опухоли",
      x = "Средний радиус опухоли",
      y = "Тип ") + geom_smooth(method = "glm", method.args = list(family = "binomial")) 
  theme_bw()
```

```{r}
# для типа и среднего площади опухоли
data %>%
    ggplot(aes(x = area_mean, y = diagnosis)) + geom_point() +
    labs(title = "Зависимость типа и средней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Тип ") + geom_smooth(method = "glm", method.args = list(family = "binomial")) 
  theme_bw()
```

```{r}
# для типа и средней текстуры опухоли
data %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) + geom_point() +
    labs(title = "Зависимость типа и средней текстуры опухоли",
      x = "Средняя текстура",
      y = "Тип ") + geom_smooth(method = "glm", method.args = list(family = "binomial")) 
  theme_bw()
```
## Задание 3  
Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента.Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?
```{r}
# датафрейм
lung <- survival::lung
head(lung)
```

```{r}
# пропуски
sum(is.na(lung))
```

```{r}
# выводим пропуски 
missing_rows <- !complete.cases(lung)
missing_counts <- sapply(lung, function(x) sum(is.na(x)))
print(missing_counts)
# оставим пропуски в покое, пока они не будут затрагивать нужные нам признаки
```
```{r}
# полные дубликаты 
lung<-lung[ !duplicated(lung),]
```

```{r}
# переменная even
lung$event <- ifelse(lung$status == 2,1,0)
print(lung$event)
```
```{r}
# датафрейм с умершими пациентами
lung_death <- filter(lung,lung$event == 1)
head(lung_death)
```
```{r}
# кривые выживаемости в выживаемости в зависимости от пола
surv_fit <- survfit(Surv(time, status) ~ sex, data = lung_death)
ggsurvplot(surv_fit, conf.int = TRUE, surv.median.line = 'hv', risk.table = TRUE)
```
Доверительные интервалы пересекаются, т.е. мы не можем говорить, что в зависимости от пола есть различия.   
Проведем тест лог-ранг. 
Гипотезы:  
Н0: значимая разница в выживаемости между полами отсутсвует.Н1: есть статистически значимая разница в выживаемости между мужчинами и женщинами. Альфа = 0.05
```{r}
survdiff(Surv(time, status) ~ sex, data = lung_death)
```
Сравнивали бы Observed и Expected, но мы все равно не можем сказать, что это достоверно, т.к. p=0.1, т.е. больше альфа. Принимает Н0: значимая разница в выживаемости между полами отсутсвует.
```{r}
# график кумулятивной функции рисков по полу
ggsurvplot(surv_fit, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```
Доверительные интервалы для двух прямых перекрываются (даже закрывают соседнюю кривую). Вероятно, нет различий 

```{r}
# регрессия Кокса
cox <- coxph(Surv(time, status) ~ sex, data = lung_death)
summary(cox)
```
Не можем сказать, что различия достоверны, т.к. p=0.1, т.е. больше альфа. Разница между группами мужчин и женщин отсутсвует. 
